name: SAM Database CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  pytest:
    defaults:
      run:
        shell: bash -el {0}

    name: Run Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: List Source Tree
        run: |
          pwd
          find * ! -type d

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Query Host Runner & Docker Environment
        run: |
          which make 2>/dev/null || { sudo apt-get update && sudo apt-get install make; }
          which docker
          docker --version
          docker compose --version
          docker buildx ls
          docker buildx inspect
          docker buildx du

      - name: Set Up CI Auth Credentials
        run: |
          cat << EOF > .env && cat .env
          #-------------------------
          # local container instance
          LOCAL_SAM_DB_USERNAME=root
          LOCAL_SAM_DB_SERVER=127.0.0.1
          LOCAL_SAM_DB_PASSWORD=root
          SAM_DB_USERNAME=\${LOCAL_SAM_DB_USERNAME}
          SAM_DB_SERVER=\${LOCAL_SAM_DB_SERVER}
          SAM_DB_PASSWORD=\${LOCAL_SAM_DB_PASSWORD}

          #-------------------------
          # system status database
          STATUS_DB_USERNAME=root
          STATUS_DB_PASSWORD=root
          STATUS_DB_SERVER=127.0.0.1
          EOF

      - name: Verify MySQL backup file exists
        run: |
          if [ ! -f containers/sam-sql-dev/backups/sam-obfuscated.sql.xz ]; then
            echo "‚ùå Backup file not found: containers/sam-sql-dev/backups/sam-obfuscated.sql.xz"
            echo "Please ensure backup is committed or use artifacts"
            exit 1
          fi
          ls -lh containers/sam-sql-dev/backups/sam-obfuscated.sql.xz

      - name: Start MySQL with backup restore
        run: |
          make -C containers/sam-sql-dev db-up

      - name: Set up Python
        uses: actions/setup-python@v5 # Use the setup-python action
        with:
          python-version: '3.x' # Specify the Python version you need (e.g., '3.9', '3.10', '3.11')
          cache: 'pip' # Enable dependency caching for pip

      - name: Install Project
        run: pip install -e ".[test]"

      - name: Add System Status MySQL Database
        run: |
          mysql -h 127.0.0.1 -proot -uroot < scripts/create_status_db.sql
          python scripts/setup_status_db.py
          python scripts/ingest_mock_status.py
          python scripts/test_status_db.py

      - name: Run Test Suite
        run: |
          pytest -v # Example: Run your tests (assuming pytest is in requirements.txt)

      # - name: Cleanup
      #   if: always()
      #   run: |
      #     make -C containers/sam-sql-dev db-down
