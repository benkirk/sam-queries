name: SAM Database CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  pytest:
    name: Run Test Suite
    runs-on: ubuntu-latest

    # defaults:
    #   run:
    #     working-directory: containers/sam-sql-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List Source Tree
        run: |
          pwd
          find * ! -type d

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Query Host Runner & Docker Environment
        run: |
          which make 2>/dev/null || { sudo apt-get update && sudo apt-get install make; }
          which docker
          docker --version
          docker compose --version
          docker buildx ls
          docker buildx inspect
          docker buildx du

      - name: Verify MySQL backup file exists
        run: |
          if [ ! -f containers/sam-sql-dev/backups/sam-obfuscated.sql.xz ]; then
            echo "‚ùå Backup file not found: containers/sam-sql-dev/backups/sam-obfuscated.sql.xz"
            echo "Please ensure backup is committed or use artifacts"
            exit 1
          fi
          ls -lh containers/sam-sql-dev/backups/sam-obfuscated.sql.xz

      - name: Start MySQL with backup restore
        run: |
          make -C containers/sam-sql-dev db-up

      # - uses: conda-incubator/setup-miniconda@v3
      #   with:
      #     activate-environment: conda-env
      #     environment-file: conda-env.yaml

      - name: Set Up Runtime Environment
        run: |
          touch .env
          make -C conda-env
          source etc/config_env.sh

      - name: Interrogate Environment
        run: |
          conda list
          df -h
          cat /etc/os-release 2>/dev/null || true
          uname -a
          nvidia-smi 2>/dev/null || true
          free -g
          lscpu
          echo && echo && echo
          echo '----------------------------------------------------------------'
          echo && echo && echo
          $(which python3)
          echo "CONDA_PREFIX=${CONDA_PREFIX}"
          echo "PYTHONPATH=${PYTHONPATH}"
          python3 --version

      - name: Run Test Suite
        run: |
          make check

      - name: Cleanup
        if: always()
        run: |
          make -C containers/sam-sql-dev db-down




  #     - name: Start MySQL with backup restore
  #       run: |
  #         echo "üöÄ Starting MySQL container with backup restore..."
  #         docker compose -f docker-compose.yaml -f docker-compose.ci.yaml up -d

  #     - name: Wait for MySQL to be healthy
  #       run: |
  #         echo "‚è≥ Waiting for MySQL to restore and become healthy..."
  #         timeout 300 bash -c '
  #           until docker compose -f docker-compose.yaml -f docker-compose.ci.yaml ps | grep -q "healthy"; do
  #             echo "  ... still waiting (checking every 5s)"
  #             docker compose -f docker-compose.yaml -f docker-compose.ci.yaml ps mysql
  #             sleep 5
  #           done
  #         '
  #         echo "‚úÖ MySQL is healthy and backup restored!"

  #     - name: Verify container health
  #       run: |
  #         docker compose -f docker-compose.yaml -f docker-compose.ci.yaml ps
  #         docker compose -f docker-compose.yaml -f docker-compose.ci.yaml logs --tail=50 mysql

  #     - name: Install MySQL client on runner
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y mysql-client

  #     - name: Test database connection from runner host
  #       run: |
  #         echo "üîç Testing connection to MySQL from runner host..."
  #         mysql -h 127.0.0.1 -u root -proot sam -e "SELECT VERSION();"

  #     - name: Verify database restoration
  #       run: |
  #         echo "üìä Verifying database was restored correctly..."

  #         # Check user count
  #         USER_COUNT=$(mysql -h 127.0.0.1 -u root -proot sam -N -e "SELECT COUNT(*) FROM users")
  #         echo "User count: $USER_COUNT"

  #         if [ "$USER_COUNT" -lt 1000 ]; then
  #           echo "‚ùå Database restore incomplete - expected >1000 users"
  #           exit 1
  #         fi

  #         # Check anonymization worked
  #         ANON_COUNT=$(mysql -h 127.0.0.1 -u root -proot sam -N -e "SELECT COUNT(*) FROM users WHERE username LIKE 'user_%'")
  #         echo "Anonymized users: $ANON_COUNT"

  #         if [ "$ANON_COUNT" -lt 1000 ]; then
  #           echo "‚ùå Anonymization incomplete"
  #           exit 1
  #         fi

  #         echo "‚úÖ Database restore and anonymization verified!"

  #     - name: Run username leak detection
  #       run: |
  #         echo "üîí Running username leak detection..."

  #         # Install Python dependencies if needed
  #         pip install pymysql sqlalchemy pyyaml

  #         # Run leak detection script
  #         python3 check_username_leak.py || true

  #     - name: Run sample queries
  #       run: |
  #         echo "üìù Running sample queries from runner host..."

  #         # Sample query 1: Get project count
  #         mysql -h 127.0.0.1 -u root -proot sam -e "
  #           SELECT COUNT(*) as project_count FROM project;
  #         "

  #         # Sample query 2: Get anonymized user samples
  #         mysql -h 127.0.0.1 -u root -proot sam -e "
  #           SELECT user_id, username, first_name, last_name
  #           FROM users
  #           WHERE username LIKE 'user_%'
  #           LIMIT 5;
  #         "

  #         # Sample query 3: Check summary tables
  #         mysql -h 127.0.0.1 -u root -proot sam -e "
  #           SELECT COUNT(*) as summary_records
  #           FROM comp_charge_summary;
  #         "

  #     - name: Test Python ORM connection
  #       run: |
  #         echo "üêç Testing Python SQLAlchemy ORM connection..."

  #         # Navigate to Python package directory
  #         cd ../../python

  #         # Install package
  #         pip install -e .

  #         # Test connection
  #         python3 << 'EOF'
  #         from sam.session import create_sam_engine
  #         from sam import User
  #         from sqlalchemy.orm import Session

  #         # Create engine (will use local MySQL on 127.0.0.1:3306)
  #         engine, _ = create_sam_engine()

  #         with Session(engine) as session:
  #             user_count = session.query(User).count()
  #             print(f"Total users via ORM: {user_count}")

  #             anon_count = session.query(User).filter(
  #                 User.username.like('user_%')
  #             ).count()
  #             print(f"Anonymized users via ORM: {anon_count}")

  #             # Get sample user
  #             user = session.query(User).filter(
  #                 User.username.like('user_%')
  #             ).first()

  #             if user:
  #                 print(f"\nSample anonymized user:")
  #                 print(f"  Username: {user.username}")
  #                 print(f"  Name: {user.first_name} {user.last_name}")
  #                 print(f"  Email: {user.primary_email}")

  #         print("\n‚úÖ Python ORM connection successful!")
  #         EOF

  #     - name: Show container logs (on failure)
  #       if: failure()
  #       run: |
  #         echo "üìã MySQL container logs:"
  #         docker compose -f docker-compose.yaml -f docker-compose.ci.yaml logs mysql

  #     - name: Cleanup
  #       if: always()
  #       run: |
  #         echo "üßπ Cleaning up..."
  #         docker compose -f docker-compose.yaml -f docker-compose.ci.yaml down -v

  # # Optional: Job to test anonymization workflow end-to-end
  # test-anonymization-workflow:
  #   name: Test Full Anonymization Workflow
  #   runs-on: ubuntu-latest

  #   defaults:
  #     run:
  #       working-directory: containers/sam-sql-dev

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Start fresh MySQL (no restore)
  #       run: |
  #         echo "üöÄ Starting fresh MySQL container..."
  #         docker compose -f docker-compose.yaml up -d

  #     - name: Wait for MySQL to be ready
  #       run: |
  #         echo "‚è≥ Waiting for MySQL to be ready..."
  #         timeout 60 bash -c '
  #           until docker compose -f docker-compose.yaml ps | grep -q "healthy" ||
  #                 docker exec sam-mysql-ci mysqladmin ping -h localhost -u root -proot > /dev/null 2>&1; do
  #             echo "  ... still waiting"
  #             sleep 3
  #           done
  #         '
  #         echo "‚úÖ MySQL is ready!"

  #     - name: Install dependencies
  #       run: |
  #         pip install pymysql sqlalchemy pyyaml

  #     - name: Load test data (optional)
  #       run: |
  #         echo "üì• Loading test dataset..."
  #         # Add your test data loading here if needed
  #         # For example, restore from a small test backup

  #     - name: Run anonymization script
  #       run: |
  #         echo "üîê Running anonymization..."
  #         # This would run your anonymization workflow
  #         # python3 anonymize_sam_db.py --config config.yaml --dry-run

  #     - name: Cleanup
  #       if: always()
  #       run: |
  #         docker compose -f docker-compose.yaml down -v
