name: SAM Database CI (Make/Conda Installation)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  pytest:
    name: Run Test Suite (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Install MySQL Client
        run: |
          sudo apt-get install -y mysql-client

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: ./conda-env/
          environment-file: conda-env.yaml

      - name: Build Conda Environment
        run: |
          make help
          cp .env.example .env
          pip install -e ".[test]"

      # currently needed for e.g. COPY --exclude syntax (1.19.0 / 2025-09-30)
      # https://docs.docker.com/build/buildkit/dockerfile-release-notes/?utm_source=chatgpt.com#1190
      - name: Install latest Docker
        uses: docker/setup-docker-action@v4
        with:
          docker-ce-version: latest   # or pin a version like "29.0.3"

      - name: Query Docker Environment
        run: |
          docker --version
          docker compose --version

      - name: Start Containers
        run: |
          make docker-up

      - name: Wait for MySQL TCP connectivity from host
        run: |
          echo "Verifying MySQL accepts TCP connections on 127.0.0.1:3306..."
          for i in $(seq 1 60); do
            if mysql -h 127.0.0.1 -proot -uroot -e "SELECT 1" 2>/dev/null; then
              echo "✅ MySQL accepting TCP connections after $((i * 5))s"
              break
            fi
            if [ $((i % 6)) -eq 0 ]; then
              echo "  Still waiting... ($((i * 5))s elapsed)"
            fi
            sleep 5
          done
          mysql -h 127.0.0.1 -proot -uroot sam -e "SELECT 1" || {
            echo "❌ SAM database not accessible via TCP!"
            docker compose logs mysql --tail=100
            exit 1
          }
          echo "✅ SAM database ready via TCP"

      - name: Run sam-search CLI tool
        run: |
          sam-search --inactive-projects user benkirk --list-projects --verbose
          sam-search project SCSG0001 --verbose --list-users

      - name: Run sam-status CLI tool
        run: |
          sam-status derecho
          sam-status casper
          sam-status jupyterhub

      - name: Test Suite
        run: |
          python3 tests/tools/orm_inventory.py
          pytest -v -n auto

      - name: Cleanup
        if: always()
        run: |
          make docker-down
