{% from 'dashboards/user/partials/project_card.html' import render_project_card with context %}
{% extends 'dashboards/base.html' %}

{% block title %}User Dashboard - SAM{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="account-statements-tab" data-toggle="tab" href="#account-statements" role="tab">
            <i class="fas fa-file-invoice-dollar"></i>
            {% if session.impersonator_id %}
                {{ user.username }}'s Accounts
            {% else %}
                My Accounts
            {% endif %}
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="user-info-tab" data-toggle="tab" href="#user-info" role="tab">
            <i class="fas fa-user-circle"></i> User Information
        </a>
    </li>
    {% if has_permission(Permission.IMPERSONATE_USERS) and not session.impersonator_id %}
    <li class="nav-item">
        <a class="nav-link" id="admin-actions-tab" data-toggle="tab" href="#admin-actions" role="tab">
            <i class="fas fa-user-shield"></i> Admin
        </a>
    </li>
    {% endif %}
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabContent">
    <!-- My Accounts Tab -->
    <div class="tab-pane fade show active" id="account-statements" role="tabpanel">
        <!-- Projects Section -->
        <div id="projects-section">
            <!-- Summary Header -->
            <div class="mb-3">
                <h5 class="text-muted">
                    <i class="fas fa-folder-open"></i>
                    <span id="project-count">{{ dashboard_data.total_projects }} Project{{ 's' if dashboard_data.total_projects != 1 else '' }}</span>
                </h5>
            </div>

            <!-- Projects List -->
            <div id="projects-list">
                {% if dashboard_data.projects %}
                    {% for project_data in dashboard_data.projects %}
                        {{ render_project_card(
                            project_data,
                            loop.index0,
                            user,
                            usage_warning_threshold,
                            usage_critical_threshold,
                            is_expanded = (dashboard_data.total_projects == 1)
                        ) }}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        You are not currently a member of any active projects.
                    </div>
                {% endif %}
            </div>

        </div>

    </div>
    <!-- End My Accounts Tab -->

    <!-- User Information Tab -->
    <div class="tab-pane fade" id="user-info" role="tabpanel">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> User Information</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <th>Username:</th>
                                <td>{{ user.username }}</td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td>{{ user.display_name }}</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>{{ user.primary_email or 'N/A' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End User Information Tab -->

    <!-- Admin Actions Tab -->
    {% if has_permission(Permission.IMPERSONATE_USERS) %}
    <div class="tab-pane fade" id="admin-actions" role="tabpanel">
        {% include 'dashboards/user/admin_section.html' %}
    </div>
    {% endif %}
    <!-- End Admin Actions Tab -->
</div>
<!-- End Tab Content -->

<!-- Member Management Modals -->
{% include 'dashboards/user/fragments/member_modals.html' %}

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/impersonation.js') }}"></script>
<script src="{{ url_for('static', filename='js/project-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/expirations.js') }}"></script>
{% endblock %}

