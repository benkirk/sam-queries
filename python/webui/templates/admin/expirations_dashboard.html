{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1>Project Expiration Monitor</h1>
            <p class="text-muted">Track upcoming expirations, recently expired projects, and abandoned users</p>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fa fa-filter"></i> Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('expirations.index') }}" class="form-horizontal">
                        <input type="hidden" name="tab" value="{{ active_tab }}">

                        <div class="row">
                            <!-- Facility Filter -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label><strong>Facilities</strong></label>
                                    <div>
                                        {% for facility_value, facility_label in all_facilities %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="facilities" value="{{ facility_value }}"
                                                   id="facility_{{ facility_value }}"
                                                   {% if facility_value in filters.facilities %}checked{% endif %}>
                                            <label class="form-check-label" for="facility_{{ facility_value }}">
                                                {{ facility_label }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Time Range Filter -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="time_range"><strong>Time Range</strong></label>
                                    <select class="form-control" id="time_range" name="time_range">
                                        <option value="">-- Select Preset --</option>
                                        {% if active_tab == 'upcoming' %}
                                            {% for key, days in upcoming_presets.items() %}
                                            <option value="{{ key }}" {% if filters.time_range == key %}selected{% endif %}>
                                                Next {{ days }} days
                                            </option>
                                            {% endfor %}
                                        {% elif active_tab == 'expired' %}
                                            {% for key, days in expired_presets.items() %}
                                            <option value="{{ key }}" {% if filters.time_range == key %}selected{% endif %}>
                                                Last {{ days }} days
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="custom_days"><strong>Custom Days</strong></label>
                                    <input type="number" class="form-control" id="custom_days"
                                           name="custom_days" placeholder="Enter number of days"
                                           value="{{ filters.custom_days or '' }}">
                                </div>
                            </div>

                            <!-- Resource Filter -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="resource"><strong>Resource (optional)</strong></label>
                                    <input type="text" class="form-control" id="resource"
                                           name="resource" placeholder="e.g., Derecho, GLADE"
                                           value="{{ filters.resource or '' }}">
                                    <small class="form-text text-muted">Leave blank for all resources</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-search"></i> Apply Filters
                                </button>
                                <a href="{{ url_for('expirations.index') }}" class="btn btn-secondary">
                                    <i class="fa fa-undo"></i> Reset
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'upcoming' %}active{% endif %}"
                       href="{{ url_for('expirations.index', tab='upcoming', **filters) }}">
                        <i class="fa fa-calendar-alt"></i> Upcoming Expirations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'expired' %}active{% endif %}"
                       href="{{ url_for('expirations.index', tab='expired', **filters) }}">
                        <i class="fa fa-exclamation-triangle"></i> Recently Expired
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if active_tab == 'abandoned' %}active{% endif %}"
                       href="{{ url_for('expirations.index', tab='abandoned', **filters) }}">
                        <i class="fa fa-user-slash"></i> Abandoned Users
                    </a>
                </li>
            </ul>

            <div class="tab-content mt-3">
                <!-- Upcoming Expirations Tab -->
                {% if active_tab == 'upcoming' %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Upcoming Project Expirations ({{ data|length }} projects)
                            <span class="float-right">
                                <a href="{{ url_for('expirations.export', export_type='upcoming', **filters) }}"
                                   class="btn btn-sm btn-success">
                                    <i class="fa fa-download"></i> Export CSV
                                </a>
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Project Code</th>
                                        <th>Title</th>
                                        <th>Lead</th>
                                        <!-- <th>Resource</th> -->
                                        <th>End Date</th>
                                        <th>Days Remaining</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data %}
                                    <tr>
                                        <td>
                                            <a href="{{ row.project_url }}" target="_blank">
                                                <strong>{{ row.projcode }}</strong>
                                            </a>
                                        </td>
                                        <td>{{ row.title }}</td>
                                        <td>
                                            {% if row.lead_url %}
                                            <a href="{{ row.lead_url }}" target="_blank">
                                                {{ row.lead_name }} ({{ row.lead_username }})
                                            </a>
                                            {% else %}
                                            {{ row.lead_name }}
                                            {% endif %}
                                        </td>
                                        <!-- <td>{{ row.resource_name }}</td> -->
                                        <td>{{ row.end_date }}</td>
                                        <td>
                                            <span class="badge {% if row.days <= 7 %}badge-danger{% elif row.days <= 30 %}badge-warning{% else %}badge-info{% endif %}">
                                                {{ row.days_label }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> No upcoming expirations found with the current filters.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Recently Expired Tab -->
                {% if active_tab == 'expired' %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Recently Expired Projects ({{ data|length }} projects)
                            <span class="float-right">
                                <a href="{{ url_for('expirations.export', export_type='expired', **filters) }}"
                                   class="btn btn-sm btn-success">
                                    <i class="fa fa-download"></i> Export CSV
                                </a>
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Project Code</th>
                                        <th>Title</th>
                                        <th>Lead</th>
                                        <!-- <th>Resource</th> -->
                                        <th>End Date</th>
                                        <th>Days Since Expiration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data %}
                                    <tr>
                                        <td>
                                            <a href="{{ row.project_url }}" target="_blank">
                                                <strong>{{ row.projcode }}</strong>
                                            </a>
                                        </td>
                                        <td>{{ row.title }}</td>
                                        <td>
                                            {% if row.lead_url %}
                                            <a href="{{ row.lead_url }}" target="_blank">
                                                {{ row.lead_name }} ({{ row.lead_username }})
                                            </a>
                                            {% else %}
                                            {{ row.lead_name }}
                                            {% endif %}
                                        </td>
                                        <!-- <td>{{ row.resource_name }}</td> -->
                                        <td>{{ row.end_date }}</td>
                                        <td>
                                            <span class="badge {% if row.days <= 30 %}badge-warning{% else %}badge-danger{% endif %}">
                                                {{ row.days_label }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> No recently expired projects found with the current filters.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Abandoned Users Tab -->
                {% if active_tab == 'abandoned' %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Abandoned Users ({{ abandoned_users|length }} users)
                            <span class="float-right">
                                <a href="{{ url_for('expirations.export', export_type='abandoned', **filters) }}"
                                   class="btn btn-sm btn-success">
                                    <i class="fa fa-download"></i> Export CSV
                                </a>
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fa fa-info-circle"></i>
                            <strong>Note:</strong> Abandoned users are active users whose only active projects
                            have recently expired allocations.
                        </div>
                        {% if abandoned_users %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Display Name</th>
                                        <th>Email</th>
                                        <th>Project Count</th>
                                        <th>Projects</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in abandoned_users %}
                                    <tr>
                                        <td>
                                            <a href="{{ user.user_url }}" target="_blank">
                                                <strong>{{ user.username }}</strong>
                                            </a>
                                        </td>
                                        <td>{{ user.display_name }}</td>
                                        <td>
                                            {% if user.email != 'N/A' %}
                                            <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                                            {% else %}
                                            {{ user.email }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ user.project_count }}</span>
                                        </td>
                                        <td>{{ user.projects }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle"></i> No abandoned users found with the current filters.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .badge {
        font-size: 0.875rem;
        padding: 0.375rem 0.625rem;
    }
</style>
{% endblock %}
