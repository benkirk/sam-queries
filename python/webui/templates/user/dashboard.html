{% extends 'user/base.html' %}

{% block title %}User Dashboard - SAM{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="account-statements-tab" data-toggle="tab" href="#account-statements" role="tab" aria-controls="account-statements" aria-selected="true">
            <i class="fas fa-file-invoice-dollar"></i> Account Statements
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="user-info-tab" data-toggle="tab" href="#user-info" role="tab" aria-controls="user-info" aria-selected="false">
            <i class="fas fa-user-circle"></i> User Information
        </a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabContent">
    <!-- Account Statements Tab -->
    <div class="tab-pane fade show active" id="account-statements" role="tabpanel" aria-labelledby="account-statements-tab">

<!-- Loading Spinner -->
<div id="loading" class="loading-spinner">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Projects Container -->
<div id="projects-container" style="display: none;">
    <!-- Summary Header -->
    <div class="mb-3">
        <h5 class="text-muted">
            <i class="fas fa-folder-open"></i>
            <span id="project-count">0</span> Projects
        </h5>
    </div>
    <!-- Projects List -->
    <div id="projects-list"></div>
</div>

<!-- No Projects Message -->
<div id="no-projects" style="display: none;">
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> You are not currently a member of any active projects.
    </div>
</div>

    </div>
    <!-- End Account Statements Tab -->

    <!-- User Information Tab -->
    <div class="tab-pane fade" id="user-info" role="tabpanel" aria-labelledby="user-info-tab">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user"></i> User Profile</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4 font-weight-bold">Username:</div>
                            <div class="col-md-8">{{ user.username }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 font-weight-bold">Full Name:</div>
                            <div class="col-md-8">{{ user.full_name }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 font-weight-bold">Primary Email:</div>
                            <div class="col-md-8">{{ user.primary_email }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 font-weight-bold">User ID:</div>
                            <div class="col-md-8">{{ user.user_id }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 font-weight-bold">Role:</div>
                            <div class="col-md-8">
                                {% for role in user.roles %}
                                <span class="badge badge-primary">{{ role }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End User Information Tab -->
</div>
<!-- End Tab Content -->

{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced project cards */
    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #0099CC;
        user-select: none;
    }

    .card-header:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }

    .chevron-icon {
        margin-right: 8px;
        color: #0099CC;
    }

    .project-stats-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-left: 3px solid #0099CC;
        transition: all 0.3s ease;
    }

    .project-stats-box:hover {
        border-left-color: #003366;
        transform: translateX(2px);
    }

    /* Project Tree Styles - Simplified */
    .tree-list {
        list-style-type: none;
        padding-left: 0;
        margin: 0;
    }

    .tree-list ul {
        list-style-type: none;
        padding-left: 2rem;
        margin: 0.5rem 0;
    }

    .tree-list li {
        padding: 0.5rem;
        margin: 0.25rem 0;
        border-left: 3px solid transparent;
    }

    .tree-list .tree-current {
        background: #e3f2fd;
        border-left-color: #0099CC;
        font-weight: 600;
    }

    .tree-list .tree-parent {
        border-left-color: #6c757d;
    }

    .tree-list .tree-inactive {
        opacity: 0.6;
    }

    .tree-list a {
        color: #0099CC;
        text-decoration: none;
    }

    .tree-list a:hover {
        text-decoration: underline;
    }

</style>
{% endblock %}

{% block extra_js %}
<script>
// Format numbers with commas
function formatNumber(num) {
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

// Get progress bar color based on percentage
function getProgressColor(percent) {
    if (percent >= 90) return 'bg-danger';
    if (percent >= 75) return 'bg-warning';
    if (percent >= 50) return 'bg-info';
    return 'bg-success';
}

// Create a project card
function createProjectCard(project, index) {
    const percentClass = getProgressColor(project.percent_used);
    const cardId = `project-${index}`;

    let resourcesHtml = '';
    if (project.resources && project.resources.length > 0) {
        resourcesHtml = `
            <div class="mt-3">
                <h6 class="mb-2">Resources:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>Resource</th>
                                <th>Status</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Allocated</th>
                                <th>Used</th>
                                <th>Remaining</th>
                                <th style="width: 200px;">Usage</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        project.resources.forEach(resource => {
            const resPercentClass = getProgressColor(resource.percent_used);
            const statusBadge = resource.status === 'Active'
                ? '<span class="badge badge-success">Active</span>'
                : '<span class="badge badge-secondary">Inactive</span>';
            const adjustments = resource.adjustments || 0;
            const startDate = resource.start_date ? new Date(resource.start_date).toLocaleDateString() : 'N/A';
            const endDate = resource.end_date ? new Date(resource.end_date).toLocaleDateString() : 'N/A';

            resourcesHtml += `
                <tr class="resource-row" style="cursor: pointer;"
                    data-projcode="${project.projcode}"
                    data-resource="${resource.resource_name}"
                    onclick="viewResourceDetails('${project.projcode}', '${resource.resource_name}')">
                    <td><strong>${resource.resource_name}</strong></td>
                    <td>${statusBadge}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td class="text-primary">${formatNumber(resource.allocated)}</td>
                    <td class="text-warning">${formatNumber(resource.used)}</td>
                    <td class="text-success">${formatNumber(resource.remaining)}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${resPercentClass}"
                                 role="progressbar"
                                 style="width: ${Math.min(resource.percent_used, 100)}%"
                                 aria-valuenow="${resource.percent_used}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                ${resource.percent_used.toFixed(1)}%
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });

        resourcesHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    return `
        <div class="card mb-3">
            <!-- Card Header (clickable) -->
            <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#${cardId}">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-1">
                            <i class="fas fa-chevron-right chevron-icon" style="transition: transform 0.3s ease;"></i>
                            <i class="fas fa-folder"></i> Project: ${project.projcode}
                            ${project.active ? '<span class="badge badge-success ml-2">Active</span>' : '<span class="badge badge-secondary ml-2">Inactive</span>'}
                        </h5>
                        <p class="mb-0"><strong>Title:</strong> ${project.title || 'No title'}</p>
                    </div>
                    <div class="col-md-4 text-right">
                        <p class="mb-0"><strong>Project Lead:</strong></p>
                        <p class="mb-0">${project.lead_name || 'Not assigned'}</p>
                    </div>
                </div>
            </div>

            <!-- Fixed Header (always visible even when collapsed) -->
            <div class="card-body border-bottom bg-light py-2 text-right text-muted" style="font-size: 0.9rem;">
                <i class="fas fa-chart-line"></i> Usage: ${project.percent_used.toFixed(1)}%
            </div>

            <!-- Main Collapsible Container -->
            <div id="${cardId}" class="collapse" data-projcode="${project.projcode}">
                <div class="card-body">

                    <!-- Section A: Overall Summary (EXPANDED by default) -->
                    <div class="card mb-2">
                        <div class="card-header py-2" style="cursor: pointer; background: #f8f9fa;" data-toggle="collapse" data-target="#summary-${index}">
                            <h6 class="mb-0">
                                <i class="fas fa-chevron-down chevron-icon"></i>
                                Overall Summary
                            </h6>
                        </div>
                        <div id="summary-${index}" class="collapse show" data-section="summary" data-projcode="${project.projcode}">
                            <div class="card-body">
                                <!-- Overall Usage Stats (4 boxes) -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="text-center p-3 project-stats-box rounded">
                                            <small class="text-muted font-weight-bold">ALLOCATED</small>
                                            <h5 class="mb-0 mt-1" style="color: #0099CC;">${formatNumber(project.total_allocated)}</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 project-stats-box rounded">
                                            <small class="text-muted font-weight-bold">USED</small>
                                            <h5 class="mb-0 mt-1" style="color: #f59e0b;">${formatNumber(project.total_used)}</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 project-stats-box rounded">
                                            <small class="text-muted font-weight-bold">REMAINING</small>
                                            <h5 class="mb-0 mt-1" style="color: #10b981;">${formatNumber(project.total_remaining)}</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 project-stats-box rounded">
                                            <small class="text-muted font-weight-bold">USAGE</small>
                                            <h5 class="mb-0 mt-1" style="color: #003366;">${project.percent_used.toFixed(1)}%</h5>
                                        </div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="progress mb-3" style="height: 30px;">
                                    <div class="progress-bar ${percentClass}"
                                         role="progressbar"
                                         style="width: ${Math.min(project.percent_used, 100)}%"
                                         aria-valuenow="${project.percent_used}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        ${project.percent_used.toFixed(1)}% Used
                                    </div>
                                </div>

                                <!-- Resources Table -->
                                ${resourcesHtml}
                            </div>
                        </div>
                    </div>

                    <!-- Section B: Project Tree (COLLAPSED by default, hidden if no tree) -->
                    <div class="card mb-2" id="tree-section-${index}">
                        <div class="card-header py-2" style="cursor: pointer; background: #f8f9fa;" data-toggle="collapse" data-target="#tree-${index}">
                            <h6 class="mb-0">
                                <i class="fas fa-chevron-right chevron-icon"></i>
                                Project Hierarchy
                            </h6>
                        </div>
                        <div id="tree-${index}" class="collapse" data-section="tree" data-projcode="${project.projcode}" data-card-index="${index}">
                            <div class="card-body">
                                <div id="tree-container-${project.projcode}">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-sitemap"></i> Loading hierarchy...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    `;
}

// Load projects data
function loadProjects() {
    fetch('/api/v1/users/me/projects?format=dashboard')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load projects');
            }
            return response.json();
        })
        .then(data => {
            // Hide loading spinner
            document.getElementById('loading').style.display = 'none';

            if (data.projects && data.projects.length > 0) {
                // Show projects container
                document.getElementById('projects-container').style.display = 'block';

                // Set project count
                document.getElementById('project-count').textContent = data.projects.length;

                // Render project cards
                const projectsList = document.getElementById('projects-list');
                projectsList.innerHTML = data.projects.map((project, index) => createProjectCard(project, index)).join('');

                // Add chevron rotation handlers for all collapsible sections
                $('.collapse').on('show.bs.collapse', function() {
                    $(this).prev('.card-header').find('.chevron-icon')
                        .removeClass('fa-chevron-right')
                        .addClass('fa-chevron-down');
                });
                $('.collapse').on('hide.bs.collapse', function() {
                    $(this).prev('.card-header').find('.chevron-icon')
                        .removeClass('fa-chevron-down')
                        .addClass('fa-chevron-right');
                });
            } else {
                // Show no projects message
                document.getElementById('no-projects').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading projects:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('projects-container').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading projects: ${error.message}
                </div>
            `;
            document.getElementById('projects-container').style.display = 'block';
        });
}

// Load project tree from API
function loadProjectTree(projcode, containerId, cardIndex) {
    const container = document.getElementById(containerId);

    // Show loading state
    container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading hierarchy...</div>';

    // Fetch project details
    fetch(`/api/v1/projects/${projcode}`)
        .then(r => r.json())
        .then(projectData => {
            // Function to count total nodes in tree
            function countTreeNodes(node) {
                let count = 1;  // Count this node
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        count += countTreeNodes(child);
                    });
                }
                return count;
            }

            // Check if there's actually a tree (more than just one project)
            const totalNodes = projectData.tree ? countTreeNodes(projectData.tree) : 1;
            const hasTree = totalNodes > 1;

            if (!hasTree) {
                // Show message for standalone projects
                container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle"></i> No project hierarchy</div>';
                return;
            }

            // Tree exists, render it
            renderSimpleProjectTree(projectData, containerId);
        })
        .catch(error => {
            console.error('Error loading project tree:', error);
            container.innerHTML = '<div class="alert alert-warning small">Unable to load hierarchy</div>';
        });
}

// Render simplified project tree - just project codes in hierarchy
function renderSimpleProjectTree(projectData, containerId) {
    const container = document.getElementById(containerId);
    const currentProjcode = projectData.projcode;

    // Helper to build tree list item
    function buildTreeItem(projcode, isCurrent) {
        let classes = [];
        let icon = '';
        let badge = '';

        if (isCurrent) {
            classes.push('tree-current');
            icon = '<i class="fas fa-arrow-right mr-2"></i>';
            badge = '<span class="badge badge-primary badge-sm ml-2">Current</span>';
        } else {
            icon = '<i class="fas fa-folder mr-2"></i>';
        }

        const classStr = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
        const linkOrText = isCurrent
            ? `<strong>${projcode}</strong>`
            : `<a href="#" onclick="navigateToProject('${projcode}'); return false;">${projcode}</a>`;

        return `<li${classStr}>${icon}${linkOrText}${badge}</li>`;
    }

    // Recursively render tree from root
    function renderTreeNode(node, depth = 0) {
        const isCurrent = node.projcode === currentProjcode;
        let html = buildTreeItem(node.projcode, isCurrent);

        if (node.children && node.children.length > 0) {
            html += '<ul>';
            node.children.forEach(child => {
                html += renderTreeNode(child, depth + 1);
            });
            html += '</ul>';
        }

        return html;
    }

    // Render the full tree starting from root
    let html = '<ul class="tree-list">';
    html += renderTreeNode(projectData.tree);
    html += '</ul>';

    container.innerHTML = html;
}

// Navigate to another project card
function navigateToProject(projcode) {
    // Find the project card
    const cards = document.querySelectorAll('[data-projcode]');
    let targetCard = null;

    for (const card of cards) {
        if (card.getAttribute('data-projcode') === projcode) {
            targetCard = card;
            break;
        }
    }

    if (targetCard) {
        // Scroll to card
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Expand the card
        $(targetCard).collapse('show');

        // Highlight briefly
        const originalBg = targetCard.style.backgroundColor;
        targetCard.style.backgroundColor = '#e3f2fd';
        setTimeout(() => {
            targetCard.style.backgroundColor = originalBg;
        }, 2000);
    } else {
        // Project not in current user's list
        alert(`Project ${projcode} is not in your project list.`);
    }
}

// Navigate to resource details page
function viewResourceDetails(projcode, resourceName) {
    window.location.href = `{{ url_for('user_dashboard.resource_details') }}?projcode=${encodeURIComponent(projcode)}&resource=${encodeURIComponent(resourceName)}`;
}

// Lazy load project tree when tree section is first opened
$(document).on('show.bs.collapse', '[data-section="tree"]', function() {
    const treeSection = $(this);
    const projcode = treeSection.data('projcode');
    const cardIndex = treeSection.data('card-index');
    const containerId = `tree-container-${projcode}`;

    // Only load once
    if (!treeSection.data('tree-loaded')) {
        loadProjectTree(projcode, containerId, cardIndex);
        treeSection.data('tree-loaded', true);
    }
});

// Load projects on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});
</script>
{% endblock %}
