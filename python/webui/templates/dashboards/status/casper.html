{% import 'dashboards/status/partials/system_header.html' as header %}
{% import 'dashboards/status/partials/login_nodes_table.html' as login %}
{% import 'dashboards/status/partials/utilization_metrics.html' as util %}
{% import 'dashboards/status/partials/job_statistics.html' as jobs %}
{% import 'dashboards/status/partials/queue_table.html' as queues %}
{% import 'dashboards/status/partials/nodetype_table.html' as nodetypes %}
{% import 'dashboards/status/partials/filesystem_table.html' as fs %}
{% import 'dashboards/status/partials/no_data_message.html' as empty %}

{% if casper_status %}
<div class="card mb-3">
    {{ header.system_header('<i class="fas fa-hdd"></i> Casper System Status', casper_status.timestamp) }}
    <div class="card-body">
        <!-- Login Nodes -->
        <h6 class="mb-3"><i class="fas fa-desktop"></i> Login Nodes</h6>
        {% if casper_login_nodes %}
        {{ login.login_nodes_table(casper_login_nodes, has_node_type=false) }}
        {% else %}
        {# Fallback to old aggregate display #}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="metric-card">
                    <h6>Login Node Status</h6>
                    <div class="value">
                        {{ casper_status.login_nodes_available }} / {{ casper_status.login_nodes_total }} Available
                    </div>
                    {% if casper_status.login_total_users is not none %}
                    <div class="text-muted mt-2">{{ casper_status.login_total_users }} total users</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Compute Nodes by Type -->
        <h6 class="mb-3"><i class="fas fa-server"></i> Compute Nodes</h6>
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="metric-card">
                    <h6>CPU Nodes</h6>
                    <div class="value">{{ casper_status.cpu_nodes_available }} / {{ casper_status.cpu_nodes_total }} Available</div>
                    {% if casper_status.cpu_nodes_down > 0 %}
                    <div class="text-danger mt-2">{{ casper_status.cpu_nodes_down }} nodes down</div>
                    {% endif %}
                    {% if casper_status.cpu_nodes_reserved > 0 %}
                    <div class="text-warning mt-1">{{ casper_status.cpu_nodes_reserved }} nodes reserved</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <h6>GPU Nodes</h6>
                    <div class="value">{{ casper_status.gpu_nodes_available }} / {{ casper_status.gpu_nodes_total }} Available</div>
                    {% if casper_status.gpu_nodes_down > 0 %}
                    <div class="text-danger mt-2">{{ casper_status.gpu_nodes_down }} nodes down</div>
                    {% endif %}
                    {% if casper_status.gpu_nodes_reserved > 0 %}
                    <div class="text-warning mt-1">{{ casper_status.gpu_nodes_reserved }} nodes reserved</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <h6>VIZ Nodes</h6>
                    <div class="value">{{ casper_status.viz_nodes_available }} / {{ casper_status.viz_nodes_total }} Available</div>
                    {% if casper_status.viz_nodes_down > 0 %}
                    <div class="text-danger mt-2">{{ casper_status.viz_nodes_down }} nodes down</div>
                    {% endif %}
                    {% if casper_status.viz_nodes_reserved > 0 %}
                    <div class="text-warning mt-1">{{ casper_status.viz_nodes_reserved }} nodes reserved</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Utilization -->
        <h6 class="mb-3"><i class="fas fa-chart-bar"></i> Resource Utilization</h6>
        {{ util.utilization_metrics(casper_status, show_gpus=true, show_viz=true) }}

        <!-- Jobs -->
        <h6 class="mb-3"><i class="fas fa-tasks"></i> Job Statistics</h6>
        {{ jobs.job_statistics(casper_status) }}

        <!-- Node Types -->
        {% if casper_node_types %}
        <h6 class="mb-3"><i class="fas fa-server"></i> Node Type Status</h6>
        {{ nodetypes.nodetype_table(casper_node_types) }}
        {% endif %}

        <!-- Queues -->
        {% if casper_queues %}
        <h6 class="mb-3"><i class="fas fa-list"></i> Queue Status</h6>
        {{ queues.queue_table(casper_queues, show_gpus=true) }}
        {% endif %}

        <!-- Reservations -->
        {% set casper_reservations = reservations|selectattr('system_name', 'equalto', 'casper')|list %}
        {% if casper_reservations %}
        <h6 class="mb-3 mt-4"><i class="fas fa-calendar-alt"></i> Maintenance &amp; Reservations</h6>
        {% for res in casper_reservations %}
        <div class="alert alert-warning mb-3" role="alert">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="alert-heading mb-2">
                        <i class="fas fa-wrench"></i> {{ res.reservation_name }}
                    </h6>
                    {% if res.description %}
                    <p class="mb-2">{{ res.description }}</p>
                    {% endif %}
                    <div class="small text-muted">
                        {% if res.node_count %}{{ res.node_count }} nodes{% endif %}
                        {% if res.partition %} - Partition: {{ res.partition }}{% endif %}
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold">{{ res.start_time.strftime('%Y-%m-%d %H:%M') }} - {{ res.end_time.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Filesystems -->
        {% if casper_filesystems %}
        <h6 class="mb-3 mt-4"><i class="fas fa-database"></i> Filesystem Status</h6>
        {{ fs.filesystem_table(casper_filesystems) }}
        {% endif %}
    </div>
</div>
{% else %}
{{ empty.no_data_message('No Casper status data available.') }}
{% endif %}
